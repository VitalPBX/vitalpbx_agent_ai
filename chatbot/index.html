<!DOCTYPE html>
<html>

<head>
    <title>VitalPBX Wiki-AI</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <script src="jquery.min.js"></script>

    <style>
        body {
            background-color: #ECE5DD; /* Background similar to WhatsApp Web */
            height: 100vh;
            margin: 0;
            font-family: 'Arial', sans-serif;
        }

        .chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 1px solid #B2AFAF;
        }

        .chat-header {
            background-color: #009688; /* Header color */
            color: white;
            padding: 10px;
            font-weight: bold;
            border-bottom: 1px solid #B2AFAF;
        }

        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .user-message {
            background-color: #DCF8C6;
            float: left;
            clear: both;
            margin: 5px 0px;
            border-radius: 10px;
            max-width: 70%;
            overflow-wrap: break-word;
            padding: 8px;
            font-size: 18px;
        }

        .bot-message {
            background-color: #ECECEC;
            float: left;
            clear: both;
            margin: 5px 0px;
            border-radius: 10px;
            max-width: 70%;
            overflow-wrap: break-word;
            padding: 8px;
            font-size: 18px;
        }

        .clearfix::after {
            content: "";
            clear: both;
            display: table;
        }

        .input-group {
            border-top: 1px solid #B2AFAF;
            padding: 10px;
            background-color: white;
        }

    </style>
</head>
<body>
    <!-- Main chat interface container -->
    <div class="chat-container">

        <!-- Chat header displaying the title 'Chatbot' -->
        <div class="chat-header">
            Chatbot
        </div>

        <!-- Container where all chat messages will appear -->
        <div class="chat-box clearfix" id="chatContent">
            <!-- Messages will appear here -->
        </div>

        <!-- User input area -->
        <div class="input-group">
            <!-- Text input for user's messages -->
            <input type="text" id="messageInput" class="form-control" placeholder="Type your message...">
            <!-- Button to send the message -->
            <div class="input-group-append">
                <button id="sendBtn" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>

    <script>
        // This code provides an interactive chat interface where users can send messages to a chatbot. 
        // The frontend communicates with a backend through a WebSocket connection. 
        // When the user sends a message, a temporary reply is displayed until the actual response from the backend is received. 
        // The chat messages from the backend are prefixed with "ASSISTANCE" and the current date and time.

        // Constants
        const RECONNECT_DELAY = 5000; // 5 seconds delay for reconnection attempts

        // Variable to hold the WebSocket connection
        let ws;
    
        // Function to establish a WebSocket connection
        function connect() {
            ws = new WebSocket(`wss://${location.hostname}:3002`);

            ws.onopen = function() {
                console.log("WebSocket connection opened");
            };

            ws.onclose = function(event) {
                // Check if the connection was closed cleanly
                if(event.wasClean) {
                    console.log("Closed cleanly, code=", event.code, ", reason=", event.reason);
                } else {
                    console.log("Connection died");
                }
                setTimeout(connect, RECONNECT_DELAY);  // Reconnect after a delay
            };

            ws.onerror = function(error) {
                console.error("WebSocket Error:", error);
            };

            // Function to handle incoming messages
            ws.onmessage = handleMessage;
        }

        // Helper function to get the current date and time
        function getCurrentDateTime() {
            const now = new Date();
            return now.toLocaleString();  // Example format: "10/20/2023, 10:12:05 AM"
        }

        // Function to process and display incoming messages
        function handleMessage(event) {
            $('.temp-reply').remove(); // Remove temporary replies
            const data = JSON.parse(event.data); // Parse incoming data
            var formattedAnswer = data.answer.replace(/\n/g, '<br>');  // Convert newline characters to HTML line breaks
 
            // Prefix the message with "ASSISTANCE" and the current date and time
            // const prefix = `<b>ASSISTANCE</b> - ${getCurrentDateTime()}<br>`;
            const prefix = `<b>Assistant</b><br>`;
            formattedAnswer = prefix + formattedAnswer; 

            var answerElement = $('<div class="bot-message"></div>');
            $('#chatContent').append(answerElement);

            // If the data status is OK, display the formatted answer, otherwise show an error
            if (data.status == 'OK') {
                typeWriter(formattedAnswer, answerElement[0]);
            } else {
                typeWriter("Error retrieving answer.", answerElement[0]);
            }

            autoScroll();  // Ensure the chatbox view is scrolled to the latest message
        }

        // Function to automatically scroll the chatbox to the latest message
        function autoScroll() {
            var chatBox = $(".chat-box");
            chatBox.scrollTop(chatBox[0].scrollHeight);
        }

        // Function to display text in a "type writer" animation
        function typeWriter(text, element, delay = 10) {
            let runningText = '';
            let index = 0;

            function typeChar() {
                if (index < text.length) {
                    let char = text.charAt(index);
                    runningText += char;
                    element.innerHTML = '';
                    element.insertAdjacentHTML('beforeend', runningText);
                    index++;
                    setTimeout(typeChar, delay);
                    autoScroll();
                }
            }
            typeChar();
        }

        $(document).ready(function() {
            // Establish the WebSocket connection upon page load
            connect();

            // Event listener for the send button
            $('#sendBtn').click(sendMessage);

            // Event listener to send the message when the 'Enter' key is pressed
            $('#messageInput').keydown(function(event) {
                if (event.which === 13) {
                    event.preventDefault();
                    sendMessage();
                }
            });

            // Function to handle sending messages
            function sendMessage() {
                var message = $('#messageInput').val();
                if (!message) return;

                // Display the user's message in the chatbox
                const prefix = `<b>You</b><br>`;
                formattedQuestion = prefix + message; 
                $('#chatContent').append('<div class="user-message">' + formattedQuestion + '</div>');
                $('#messageInput').val(''); // Clear the input box

                // Display a temporary reply while waiting for a response
                var tempReply = '<div class="bot-message temp-reply">Please wait...</div>';
                $('#chatContent').append(tempReply);

                autoScroll();  // Ensure the chatbox view is scrolled to the latest message

                // Send the user's message over the WebSocket connection
                ws.send(JSON.stringify({ message: message }));
            }

        });
    </script>
</body>
</html>
